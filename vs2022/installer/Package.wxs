<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
  xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
  xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal"
  xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <!-- This include is generated by the CreateVersionWxi task in the project file. -->
  <?include version.wxi ?>

  <Package
    Name="Qubes Windows Tools v$(QWTVersion)"
    Manufacturer="Invisible Things Lab"
    Version="$(QWTVersion)"
    ProductCode="*"
    UpgradeCode="{14BCB82F-3C4B-4C77-8E00-20BAEBC61354}"
    Scope="perMachine">
    <MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)" />
    <MediaTemplate EmbedCab="yes" />

    <Icon Id="icon.ico" SourceFile="..\..\qubes.ico" />
    <Property Id="DISABLEADVTSHORTCUTS" Value="1" />
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <!-- TODO Launch Condition="MsiNTProductType = 1 AND VersionNT64 = 1000" Message="!(loc.UnsupportedOsError)" /-->

    <WixVariable Id="WixUILicenseRtf" Value="..\..\LICENSE.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="..\..\qubes.png" />
    <ui:WixUI Id="WixUI_FeatureTree" />

    <?if $(env.TEST_SIGN) ?>
        <Binary Id="SigningCertDrivers" SourceFile="$(env.QUBES_REPO)\vmm-xen-windows-pvdrivers\sign.crt" />
        <Binary Id="SigningCertVchan" SourceFile="$(env.QUBES_REPO)\core-vchan-xen\sign.crt" />
        <Binary Id="SigningCertUtils" SourceFile="$(env.QUBES_REPO)\windows-utils\sign.crt" />
        <Binary Id="SigningCertDb" SourceFile="$(env.QUBES_REPO)\core-qubesdb\sign.crt" />
        <Binary Id="SigningCertAgent" SourceFile="$(env.QUBES_REPO)\core-agent-windows\sign.crt" />
        <Binary Id="SigningCertGui" SourceFile="$(env.QUBES_REPO)\gui-agent-windows\sign.crt" />
    <?endif?>

    <Binary Id="InstallHelper" SourceFile="..\x64\$(var.Configuration)\install-helper\install-helper.exe" />

    <!-- This utility adds right to create symbolic links to Users and stops xenbus_monitor service
         to prevent popups that ask for restart before we finish installation. -->
    <CustomAction
      Id="RunInstallHelper"
      BinaryRef="InstallHelper"
      ExeCommand=""
      Execute="deferred"
      Impersonate="no"
      Return="asyncNoWait" />

    <SetProperty
      Id="PreparePrivateImg"
      Value='"powershell.exe" -ExecutionPolicy Bypass -NonInteractive -InputFormat None -File "[BIN_DIR]prepare-private-img.ps1"'
      Sequence="execute"
      Before="PreparePrivateImg" />

    <CustomAction
      Id="PreparePrivateImg"
      BinaryRef="Wix4UtilCA_X64"
      DllEntry="WixQuietExec"
      Execute="deferred"
      Impersonate="no"
      Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="RunInstallHelper" Before="InstallFiles" />
      <Custom Action="PreparePrivateImg" After="InstallFiles" Condition="NOT Installed" />
      <ScheduleReboot After="InstallFinalize" />
    </InstallExecuteSequence>

    <Feature
      Id="PvDriversCore"
      AllowAbsent="yes"
      AllowAdvertise="no"
      Title="!(loc.FeaturePvDriversCoreTitle)"
      Description="!(loc.FeaturePvDriversCoreDescription)">
      <ComponentGroupRef Id="PvDriversCoreComponents" />
    </Feature>

    <Feature
      Id="Core"
      AllowAbsent="yes"
      AllowAdvertise="no"
      Title="!(loc.FeatureCoreTitle)"
      Description="!(loc.FeatureCoreDescription)">
      <ComponentGroupRef Id="CoreComponents" />
    </Feature>

    <Feature
      Id="Gui"
      AllowAbsent="yes"
      AllowAdvertise="no"
      Title="!(loc.FeatureGuiTitle)"
      Description="!(loc.FeatureGuiDescription)">
      <ComponentGroupRef Id="GuiComponents" />
    </Feature>

    <Feature
      Id="MoveUsers"
      AllowAbsent="yes"
      AllowAdvertise="no"
      Title="!(loc.FeatureMoveUsersTitle)"
      Description="!(loc.FeatureMoveUsersDescription)">
      <ComponentGroupRef Id="MoveUsersComponents" />
    </Feature>

    <Feature
      Id="PvDriversNetwork"
      AllowAbsent="yes"
      AllowAdvertise="no"
      Title="!(loc.FeaturePvDriversNetworkTitle)"
      Description="!(loc.FeaturePvDriversNetworkDescription)">
      <ComponentGroupRef Id="PvDriversNetworkComponents" />
    </Feature>

    <Feature
    Id="PvDriversDisk"
    AllowAbsent="yes"
    AllowAdvertise="no"
    Title="!(loc.FeaturePvDriversDiskTitle)"
    Description="!(loc.FeaturePvDriversDiskDescription)">
      <ComponentGroupRef Id="PvDriversDiskComponents" />
    </Feature>
  </Package>
</Wix>
